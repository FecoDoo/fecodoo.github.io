<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=robots content="nofollow"><meta name=description content="Yao Kai"><meta name=aplus-xplug content="NONE"><meta name=keyword content="fecodoo,yao kai"><meta name=generator content="Hugo 0.111.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>Type, Object & Metaclass in Python &#183; Y. Kai</title><meta name=description content><link type=text/css rel=stylesheet href=https://blog.fecodoo.ml/css/print.css media=print><link type=text/css rel=stylesheet href=https://blog.fecodoo.ml/css/poole.css><link type=text/css rel=stylesheet href=https://blog.fecodoo.ml/css/syntax.css><link type=text/css rel=stylesheet href=https://blog.fecodoo.ml/css/hyde.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Blinker:wght@300;400&family=Noto+Sans+SC&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.ico></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://blog.fecodoo.ml/><h1>Y. Kai</h1></a><p class=lead>无不克则莫知其极，莫知其极，可以有国</p></div><nav><ul class=sidebar-nav><li><a href=https://blog.fecodoo.ml/>Home</a></li><li><a href=https://github.com/fecodoo/>Github</a></li><li><a href=https://t.me/fecodoo>Telegram</a></li></ul></nav><p class=copyright>&copy; 2023. All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=post-title>Type, Object & Metaclass in Python</div><time datetime=2019-08-15T11:22:14+0800 class=post-date>Thu, Aug 15, 2019</time><h2 id=type和object的关系>type和object的关系</h2><p>一句话简述：<code>types</code>是<code>objects</code>的一个子类，<code>objects</code>是<code>type</code>的一个实例。在Python的世界中，<code>object</code>是<strong>类父子关系</strong>的顶端，所有的数据类型的<strong>父类</strong>都是它；<code>type</code>是<strong>类型实例关系</strong>的顶端，所有<strong>对象</strong>都是它的<strong>实例</strong>。它们两个的关系可以这样描述：</p><p><img src="https://pic1.zhimg.com/80/ca54cfa2cc510d2dcc40e3cc7fb2e051_1440w.jpg?source=1940ef5c" alt=rel></p><ul><li>白板上的第一列，目前只有<code>type</code>，我们先把这列的东西叫<code>Type</code>。</li><li>白板上的第二列，它们既是第三列的<strong>类型</strong>，又是第一列的<strong>实例</strong>，我们把这列的对象叫<code>TypeObject</code>。</li><li>白板上的第三列，它们是第二列类型的实例，而没有<strong>父类</strong>（__bases__）的，我们把它们叫<code>Instance</code>。</li></ul><p><a href=https://www.zhihu.com/question/38791962/answer/78172929>详见知乎：jeff kit</a></p><h2 id=metaclass>metaclass</h2><p><code>metaclass</code>常被用来在<strong>类实例化</strong>前做一些<strong>动态更改类属性</strong>的事情，比如，依赖于自省，控制继承等等。它的作用简而言之为：</p><ul><li>中断类的默认创建</li><li>修改类属性，方法等</li><li>返回修改后的类</li></ul><p><code>metaclass</code>继承自<code>type</code>，是类的类。
以下是一个最简单的<code>metaclass</code>例子</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyMetaclass</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, name: str, bases: set, attrs: dict) <span style=color:#f92672>-&gt;</span> type:
</span></span><span style=display:flex><span>        <span style=color:#75715e># some custom process</span>
</span></span><span style=display:flex><span>        attrs_processed <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, val <span style=color:#f92672>in</span> attrs<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#39;__&#39;</span>):
</span></span><span style=display:flex><span>                uppercase_attr[name<span style=color:#f92672>.</span>upper()] <span style=color:#f92672>=</span> val
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                uppercase_attr[name] <span style=color:#f92672>=</span> val
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__new__(cls, name, bases, attrs_processed)
</span></span></code></pre></div><p><code>metaclass</code>的一个主要用途就是构建API。Django(一个python写的web框架)的ORM就是一个例子。</p><p>用Django先定义了以下Model:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>    age <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>IntegerField()
</span></span></code></pre></div><p>然后执行下面代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    guy <span style=color:#f92672>=</span> Person<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>get(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;bob&#39;</span>)
</span></span><span style=display:flex><span>    print guy<span style=color:#f92672>.</span>age  <span style=color:#75715e># result is 35</span>
</span></span></code></pre></div><p>这里打印的输出并不是IntegerField，而是一个int，int是从数据库中获取的。
这是因为<code>models.Model</code>使用<code>metaclass</code>来实现了复杂的数据库查询。但对于你看来，这就是简单的API而已，不用关心背后的复杂工作。</p><p><a href="https://segmentfault.com/a/1190000007255412#:~:text=%E8%87%AA%E5%AE%9A%E4%B9%89metaclass,%E4%BD%BF%E7%94%A8%E5%AE%83%E6%9D%A5%E5%88%9B%E9%80%A0%E7%B1%BB%E3%80%82">本节引用</a></p></div></main></body></html>